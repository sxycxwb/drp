@{
    ViewBag.Title = "Form";
    Layout = "~/Views/Shared/_LayoutIndex.cshtml";
}
<script src="~/Content/js/jsrender/jsrender.min.js"></script>
<link href="~/Content/js/select2/select2.min.css" rel="stylesheet" />
<script src="~/Content/js/select2/select2.min.js"></script>
<script src="~/Content/js/validate/jquery.validate.min.js"></script>
<script src="~/Content/js/datepicker/WdatePicker.js"></script>
<script>
    var keyValue = $.request("keyValue");
    $(function () {

        initControl();
        $('#layout').layout();
        treeView();
        gridList();

    });

    function closeLayer() {
        $.modalClose();
    }

    function initControl() {
        BindProductList(keyValue);//绑定客户已设置产品列表

        $('#F_ProductName').attr('readonly', 'readonly');
        $('#F_ChargePattern').attr('readonly', 'readonly');
        $('#F_CostPrice').attr('readonly', 'readonly');
        $('#F_RoyaltyRate').attr('readonly', 'readonly');

        //产品取消设置按钮
        $('.shut').click(function () {
            $(this).css('cursor', 'pointer');
        });

        $('#btnSureAdd').click(function () {
            var productName = $('#F_ProductName').val();
            var postData = $("#form1").formSerialize();
            postData["customerId"] = keyValue;
            postData["keyValue"] = $('#F_ProductId').val();

            if ($('[name=__RequestVerificationToken]').length > 0) {
                postData["__RequestVerificationToken"] = $('[name=__RequestVerificationToken]').val();
            }
            var confirmStr = "修改";
            var content = $('#btnSureAdd').html();
            if (content.indexOf("添加") != -1) {
                postData["flag"] = "add";
                confirmStr = "添加";
            }
            $.modalConfirm("注：您确定要" + confirmStr + "产品【" + productName + "】吗？", function (r) {
                if (r) {

                    var options = {
                        url: "/DrpServManage/Customer/SubmitProduct",
                        param: postData,
                        success: function () {
                            //$.currentWindow().$("#gridList").trigger("reloadGrid");
                        }
                    }

                    var defaults = {
                        url: "",
                        param: [],
                        loading: "正在提交数据...",
                        success: null,
                        close: true
                    };
                    options = $.extend(defaults, options);
                    $.loading(true, options.loading);
                    window.setTimeout(function () {
                        if ($('[name=__RequestVerificationToken]').length > 0) {
                            options.param["__RequestVerificationToken"] = $('[name=__RequestVerificationToken]').val();
                        }
                        var sid = $.request("sid");
                        var url = "/DrpServManage/Customer/SubmitProduct";
                        if (sid != "" && sid != null && typeof (sid) != undefined)
                            url = url + "?sid=" + sid;

                        $.ajax({
                            url:url,
                            data: options.param,
                            type: "post",
                            dataType: "json",
                            success: function (data) {
                                if (data.state == "success") {
                                    options.success(data);
                                    $.modalMsg(data.message, data.state);
                                    BindProductList(keyValue);
                                    //重新加载产品列表
                                } else {
                                    $.modalAlert(data.message, data.state);
                                }
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                $.loading(false);
                                $.modalMsg(errorThrown, "error");
                            },
                            beforeSend: function () {
                                $.loading(true, options.loading);
                            },
                            complete: function () {
                                $.loading(false);
                            }
                        });
                    }, 500);

                }
            });
        });
    }

    function treeView() {
        var sid = $.request("sid");
        var url = "/DrpServManage/ProductCategory/GetTreeJson";
        var clickUrl = "/DrpServManage/Product/GetGridJson";

        if (sid != "" && sid != null && typeof (sid) != undefined){
            url = url + "?sid=" + sid;
            clickUrl = clickUrl + "?sid=" + sid;
        }

        $("#categroyTree").treeview({
            url: url,
            onnodeclick: function (item) {
                $("#txt_keyword").val('');
                $("#gridList").jqGrid('setGridParam', {
                    url: clickUrl,
                    postData: { categoryId: $("#categroyTree").getCurrentNode().id, keyword: $("#txt_keyword").val() },
                }).trigger('reloadGrid');
            }
        });
    }

    function dataGrid(gridOptions) {
        var defaults = {
            datatype: "json",
            autowidth: true,
            rownumbers: true,
            shrinkToFit: false,
            gridview: true
        };
        var $element = $("#gridList");
        gridOptions["onSelectRow"] = function (rowid) {
            var productId = $("#gridList").jqGridRowValue().F_Id;
            $('#F_ProductId').val(productId);
            BindProduct(productId, 'add');
        };

        var options = $.extend(defaults, gridOptions);
        $element.jqGrid(options);
    }

    function BindProduct(productId, flag) {
        $.myAjaxGet("/DrpServManage/Product/GetFormJson", { keyValue: productId }, false, function (data) {
            var btnContent = "确认并添加";
            if (flag == "edit")
                btnContent = "确认并修改";
            $('#btnSureAdd').html(btnContent);
            $("#form1").formSerialize(data);
            $('#chargeAmountRange').html('(范围:' + data.F_ChargeAmountMin + '~' + data.F_ChargeAmountMax + ')');
            $('#F_ProductId').val(data.F_Id);
        });
    }

    function BindProductList(customerId) {
        $.myAjaxGet("/DrpServManage/Customer/GetProductJson", { keyValue: customerId }, false, function (data) {
            var productListHtml = $("#listTemplate").render(data);
            $("#productList").html(productListHtml);
            $('.productName').mouseover(function () {
                $(this).css('cursor', 'pointer');
            });
            $('.productName').click(function () {
                var productId = $(this).attr('id');
                var productPrice = $(this).attr('price');
                BindProduct(productId, 'edit');
                $('#F_ChargeAmount').val(productPrice);
            });

            $('.shut').click(function () {
                var productName = $(this).parent().find('.productName').html();
                var fid = $(this).parent().attr('id');
                $.modalConfirm("注：您确定要移除产品【" + productName + "】吗？", function (r) {
                    if (r) {
                        $.myAjaxPost("/DrpServManage/Product/GetFormJson", { keyValue: fid }, false, function (data) {
                            if (data.state == "success") {
                                $.modalMsg(data.message, data.state);
                                BindProductList(keyValue);
                                //重新加载产品列表
                            } else {
                                $.modalAlert(data.message, data.state);
                            }
                        });
                    }
                });
            });
        });

    }

    function gridList() {
        dataGrid({
            //url: "/DrpServManage/Product/GetGridJson",
            height: $(window).height() - $(document).height() / 2 - 85,
            colModel: [
                { label: '主键', name: 'F_Id', hidden: true },
                { label: '产品名称', name: 'F_ProductName', width: 180, align: 'left' },
                {
                    label: '计费模式',
                    name: 'F_ChargePattern',
                    width: 70,
                    align: 'left',
                    formatter: function (cellvalue) {
                        if (cellvalue == "0") {
                            return "产品";
                        } else if (cellvalue == "1") {
                            return "模块";
                        }
                    }
                },
                {
                    label: '成本价(元)',
                    name: 'F_CostPrice',
                    width: 100,
                    align: 'left',
                    formatter: function (cellvalue) {
                        return cellvalue.toFixed(2);
                    }
                },
                {
                    label: '销售价(元)',
                    name: 'F_ChargeAmount',
                    width: 100,
                    align: 'left',
                    formatter: function (cellvalue) {
                        return cellvalue.toFixed(2);
                    }
                },
                { label: '计费方式', name: 'F_ChargeStyle', width: 70, align: 'left' },
                { label: '产品描述', name: 'F_Description', width: 250, align: 'left' }
            ],
            pager: "#gridPager",
            sortname: 'F_CreatorTime desc',
            viewrecords: true
        });

    }

</script>
<style>
    .formUnit {
        display: inline-block;
        margin-left: 4px;
        font-weight: bold;
    }

    .formRange {
        display: inline-block;
        margin-left: 4px;
        font-weight: bold;
        color: red;
    }

    .product {
        float: left;
        margin-top: 5px;
        margin-left: 10px;
        width: 18%;
        height: 40px;
        line-height: 40px;
        border: #83b3d9 1px solid;
        background: #f2f7fb;
    }

    .productName {
        padding: 4px;
        line-height: 32px;
        font-size: 14px;
        font-weight: bold;
        width: 70%;
        display: inline-block !important;
        display: inline;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
    }


    .shut {
        width: 45px;
        height: 18px;
        float: right;
        margin-right: 0px;
        background: url("../../../../Content/img/sh.png") no-repeat 0px 0px;
    }

        .shut:hover {
            background: url("../../../../Content/img/sh.png") no-repeat 0px -25px;
        }
</style>

<div class="ui-layout" id="layout" style="height: 50%; width: 100%;">
    <div class="ui-layout-west">
        <div id="categroyTree"></div>
    </div>
    <div class="ui-layout-center">
        <div class="gridPanel" style="margin-top: 5px;">
            <table id="gridList"></table>
            <div id="gridPager"></div>
        </div>
    </div>
</div>

<div id="form1" ng-app="app">
    <table class="form">
        <tr>
            <th class="formTitle"><span class="required-span">*</span>产品名称</th>
            <td class="formValue">
                <input id="F_ProductName" name="F_ProductName" type="text" class="form-control required" placeholder="请输入名称" />
            </td>
            <th class="formTitle"><span class="required-span">*</span>计费模式</th>
            <td class="formValue">
                <select id="F_ChargePattern" name="F_ChargePattern" class="form-control required" style="height: 20px; width: 80%;">
                    <option value="">==请选择==</option>
                    <option value="0" title="expand">产品</option>
                    <option value="1" title="iframe">模块</option>
                </select>
            </td>
            <th class="formTitle"><span class="required-span">*</span>计费方式</th>
            <td class="formValue">
                <select id="F_ChargeStyle" name="F_ChargeStyle" class="form-control required" style="height: 20px; width: 80%;">
                    <option value="">==请选择==</option>
                    <option value="year">年</option>
                    @*<option value="quarter">季度</option>*@
                    <option value="month">月</option>
                    @*<option value="week">周</option>
                        <option value="day">日</option>*@
                </select>
            </td>
        </tr>
        <tr>
            <th class="formTitle"><span class="required-span">*</span>成本价</th>
            <td class="formValue">
                <input id="F_CostPrice" name="F_CostPrice" type="number" class="form-control required" style="display: inline-block; width: 40%;" placeholder="请输入成本价" />
                <span class="formUnit"> 元</span>
            </td>
            <th class="formTitle"><span class="required-span">*</span>销售价</th>
            <td class="formValue">
                <input id="F_ChargeAmount" name="F_ChargeAmount" type="number" class="form-control required" style="display: inline-block; width: 40%;" placeholder="请输入销售价" />
                <span class="formUnit"> 元</span>
                <span id="chargeAmountRange" class="formRange"></span>
            </td>
            <th class="formTitle"><span class="required-span">*</span>代理商提成率</th>
            <td class="formValue">
                <input id="F_RoyaltyRate" name="F_RoyaltyRate" type="number" class="form-control required" style="display: inline-block; width: 40%;" placeholder="请输入提成率" />
                <span class="formUnit"> %</span>
            </td>
        </tr>
        <tr style="height: 50px;">
            <th></th>
            <td><button class="btn btn-primary right-align" id="btnSureAdd">确认并添加</button></td>
            <th></th>
            <td></td>
            <th></th>
            <td></td>
        </tr>

    </table>
    <div style="display: none;">
        <input id="F_ProductId" name="F_ProductId" />
    </div>

    @*<div style="margin-top: 10px; margin-left: 10px; margin-right: 10px;">
            <div style="padding-top: 20px; margin-right: 30px;" id="productList">

            </div>

        </div>*@
</div>

<hr style="height:1px;border:none;border-top:1px solid #ddd; margin-top: 5px; margin-bottom: 0;" />

<div>
    <div class="productLeft" style="float: left; margin-top: 5%;width: 10%; font-weight: bold; text-align: center;">
        已设置产品
    </div>
    <div id="productList" class="productRight" style="float: left; width: 90%;">
    </div>
</div>
<script type="text/x-jsrender" id="listTemplate">
    <div class="product" id="{{:fid}}">
        <div class="shut"></div>
        <div class="productName" id="{{:productId}}" price="{{:productPrice}}">
        {{:productName}}
        </div>
    </div>
</script>